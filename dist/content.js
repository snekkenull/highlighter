(()=>{"use strict";class t{static findBestMatch(t,e,n){const o=t.slice(Math.max(0,e),Math.min(t.length,n)),i=Math.max(0,e-this.FUZZY_MARGIN),r=Math.min(t.length,n+this.FUZZY_MARGIN);let a=null,s=0;for(let e=i;e<=r-o.length;e++){const n=t.slice(e,e+o.length),i=this.calculateSimilarity(o,n);i>s&&i>=this.MIN_CONFIDENCE&&(a={start:e,end:e+n.length,confidence:i},s=i)}return a}static calculateSimilarity(t,e){const n=t.length,o=e.length,i=[];for(let t=0;t<=n;t++)i[t]=[t];for(let t=0;t<=o;t++)i[0][t]=t;for(let r=1;r<=n;r++)for(let n=1;n<=o;n++){const o=t[r-1]===e[n-1]?0:1;i[r][n]=Math.min(i[r-1][n]+1,i[r][n-1]+1,i[r-1][n-1]+o)}return 1-i[n][o]/Math.max(n,o)}}let e,n;t.FUZZY_MARGIN=10,t.MIN_CONFIDENCE=.8;let o=new Set,i=!1,r=new Map,a=[],s=!1,l=new Map;const h=document.createElement("style");h.textContent="\n  @keyframes highlightFade {\n    from { background-color: transparent; }\n    to { background-color: #FFEB3B; }\n  }\n\n  @keyframes fadeIn {\n    from { opacity: 0; transform: translateY(10px); }\n    to { opacity: 1; transform: translateY(0); }\n  }\n\n  @keyframes fadeOut {\n    from { opacity: 1; transform: translateY(0); }\n    to { opacity: 0; transform: translateY(10px); }\n  }\n\n  .highlight-toast-container {\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    z-index: 10000;\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n  }\n\n  .highlight-toast {\n    background-color: #333;\n    color: white;\n    padding: 12px 20px;\n    border-radius: 4px;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n    animation: fadeIn 0.3s ease-out;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  }\n\n  .highlight-toast.success {\n    background-color: #4caf50;\n  }\n\n  .highlight-toast.error {\n    background-color: #f44336;\n  }\n\n  .highlight-toast.processing {\n    background-color: #2196f3;\n  }\n  ",document.head.appendChild(h);const c=document.createElement("div");function g(t,e="processing",n=3e3){const o=document.createElement("div");return o.className=`highlight-toast ${e}`,o.textContent=t,c.appendChild(o),n>0&&setTimeout((()=>{o.style.animation="fadeOut 0.3s ease-in forwards",setTimeout((()=>{c.removeChild(o)}),300)}),n),o}function d(t){const e=[],n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null);let o;for(;o=n.nextNode();)e.push(o);return e}async function m(t){if(!i)return;const n=d(t),h=n.map((t=>t.textContent)).join(" "),p=t.getAttribute("data-highlight-id")||`highlight-${Math.random().toString(36).substr(2,9)}`;t.setAttribute("data-highlight-id",p);const w=l.get(p)||0;if(w>=h.length)return void o.add(t);const y=w,x=Math.min(y+1e3,h.length),b=h.slice(y,x),E=`${p}-${y}-${x}`;return r.has(E)?(f(t,n,r.get(E)),l.set(p,x),void(x>=h.length&&o.add(t))):new Promise(((d,w)=>{a.push((async()=>{try{if(!i)return void d();await async function(t,n,o,i=0){let a=null;try{a=g("Processing highlights...","processing",0);const s=await u(`${e.baseUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"system",content:e.prompt},{role:"user",content:n}]})});let l;try{l=await s.json(),console.log("API Response:",l)}catch(t){throw console.error("Response parsing error:",t),new Error("Failed to parse API response as JSON")}if(!l.choices?.[0]?.message?.content)throw new Error("Invalid API response: missing required fields");const h=function(t){try{if(console.debug("Raw response content:",t),"string"==typeof t&&t.includes('"content":'))try{const e=JSON.parse(t);e.choices?.[0]?.message?.content&&(t=e.choices[0].message.content.trim(),console.debug("Extracted content from OpenAI response:",t))}catch(t){console.debug("Failed to parse OpenAI response format:",t)}const e=t.match(/\[\s*{[^]*}\s*\]/g);e&&(t=e[0],console.debug("Extracted JSON array string:",t));const n=JSON.parse(t);if(!Array.isArray(n))throw new Error("Response is not an array");return n.forEach(((t,e)=>{if(!t||"object"!=typeof t)throw new Error(`Invalid highlight at index ${e}: not an object`);if(!t.text||"string"!=typeof t.text)throw new Error(`Invalid highlight at index ${e}: text must be a string`);if(0===t.text.trim().length)throw new Error(`Invalid highlight at index ${e}: text cannot be empty`)})),n}catch(t){console.error("JSON extraction failed:",t);const e=t instanceof Error?t.message:"Unknown error";throw new Error(`Failed to extract valid JSON: ${e}`)}}(l.choices[0].message.content);if(!Array.isArray(h))throw new Error("Invalid highlights format");const d=`${t.getAttribute("data-highlight-id")}-${i}-${i+n.length}`;if(r.size>=100){const t=r.keys().next();!t.done&&t.value&&r.delete(t.value)}r.set(d,h),f(t,o,h),a&&c.removeChild(a),g("Highlights applied successfully!","success")}catch(e){const n=e instanceof Error?e.message:"Unknown error";throw console.error("Failed to process element:",n),t.setAttribute("data-highlight-error",n),a&&c.removeChild(a),g(`Error: ${n}`,"error"),e}}(t,b,n,y),l.set(p,x),x>=h.length?o.add(t):await m(t),d()}catch(t){w(t)}})),async function(){if(!s){s=!0;try{for(;a.length>0;){const t=a[0];if(t)try{await t(),a.shift(),await new Promise((t=>setTimeout(t,5e3)))}catch(t){console.error("Error processing queue item:",t),a.shift(),await new Promise((t=>setTimeout(t,5e3)))}}}finally{s=!1}}}()}))}async function u(t,e,n=3){try{const n=await fetch(t,e);if(!n.ok)throw new Error(`API request failed: ${n.statusText}`);return n}catch(o){if(n>0)return await new Promise((t=>setTimeout(t,1e3))),u(t,e,n-1);throw o}}c.className="highlight-toast-container",document.body.appendChild(c),document.head.appendChild(h);let p=new Set;function f(n,o,i){if(!o.length)return;const r=n.getAttribute("data-highlight-id")||`highlight-${Math.random().toString(36).substr(2,9)}`;n.setAttribute("data-highlight-id",r);let a=n.parentElement?.querySelector(".highlight-wrapper");a||(a=document.createElement("div"),a.className="highlight-wrapper",a.style.position="relative",n.parentNode?.insertBefore(a,n),a.appendChild(n));const s=window.location.href,l=`highlight-data-${s}-${r}`,h={text:o.map((t=>t.textContent)).join(" "),highlights:i,timestamp:Date.now(),url:s};try{chrome.storage.local.set({[l]:h})}catch(t){console.error("Failed to store highlight data:",t)}const c=document.createDocumentFragment(),g=document.createRange();i.forEach((({text:n},i)=>{try{const i=`${r}-${n}`;if(p.has(i))return;const s=o.map((t=>t.textContent)).join(" "),l=s.indexOf(n);let h=-1!==l?{start:l,end:l+n.length}:t.findBestMatch(s,Math.max(0,l-50),Math.min(s.length,l+n.length+50));if(!h)return void console.warn("Could not find reliable match for text:",{text:n});let d=0,m=null,u=null,f=0,w=0;for(const t of o){const e=(t.textContent||"").length,n=d+e;if(!m&&h.start<=n&&(m=t,f=h.start-d),!u&&h.end<=n){u=t,w=h.end-d;break}d+=e}if(!m||!u)return void console.warn("Could not find valid text nodes for text:",{text:n});g.setStart(m,f),g.setEnd(u,w);const y=g.getClientRects(),x=a.getBoundingClientRect();Array.from(y).forEach((t=>{if(0===t.width||0===t.height)return;const n=document.createElement("div");n.className="text-highlight",n.setAttribute("data-highlight-id",r),n.style.position="absolute",n.style.backgroundColor=e.highlightColor||"#FFEB3B",n.style.opacity="0.5",n.style.pointerEvents="none",n.style.zIndex="-1",n.style.animation=`highlightFade ${e.animationSpeed||.5}s ease-in-out`;const o=t.top+window.scrollY,i=t.left+window.scrollX,a=x.top+window.scrollY,s=x.left+window.scrollX;n.style.left=i-s+"px",n.style.top=o-a+"px",n.style.width=`${t.width}px`,n.style.height=`${t.height}px`,c.appendChild(n)})),p.add(i)}catch(t){console.error(`Error applying highlight at index ${i}:`,t)}})),a.appendChild(c)}async function w(){try{const{highlightSettings:t}=await chrome.storage.sync.get({highlightSettings:{apiKey:"",baseUrl:"https://api.openai.com",model:"gpt-3.5-turbo",presetPrompt:"important",customPrompt:"",prompt:'IMPORTANT: You must follow these rules exactly:\n1. Return ONLY a JSON array of objects\n2. Each object must have three properties:\n   - text: the exact text content to highlight\n   - start: approximate start index (number)\n   - end: approximate end index (number)\n3. Format must be: [{"text": string, "start": number, "end": number}]',theme:"light",animationSpeed:.5,highlightColor:"#FFEB3B"}});if(e=t,!e.apiKey)return void console.warn("API key not set. Please configure in extension options.");const r=window.location.hostname,{whitelistedSites:a=[]}=await chrome.storage.sync.get({whitelistedSites:[]});if(!a.includes(r))return void console.log("Site not whitelisted. Waiting for manual activation.");i=!0,n=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&t.target instanceof HTMLElement&&m(t.target).catch((t=>{console.error("Failed to process element:",t)}))}))}),{threshold:.1,rootMargin:"50px"});const s=window.location.href,l=document.querySelectorAll("p, article, section, .content, main");try{const t=await chrome.storage.local.get(null),e=Object.entries(t).filter((([t])=>t.startsWith(`highlight-data-${s}-`)));for(const t of l)if(t instanceof HTMLElement){const i=t.getAttribute("data-highlight-id")||`highlight-${Math.random().toString(36).substr(2,9)}`;t.setAttribute("data-highlight-id",i);const r=`highlight-data-${s}-${i}`,a=e.find((([t])=>t===r));if(a){const[e,n]=a;if(n&&n.highlights){f(t,d(t),n.highlights),o.add(t);continue}}o.has(t)||n.observe(t)}}catch(t){console.error("Failed to load cached highlights:",t),l.forEach((t=>{t instanceof HTMLElement&&!o.has(t)&&n.observe(t)}))}}catch(t){console.error("Failed to initialize extension:",t)}}chrome.runtime.onMessage.addListener(((t,e,n)=>"ping"===t.action?(n({status:"alive"}),!0):"getHighlightingState"===t.action?(n({isEnabled:i}),!0):"toggleHighlight"===t.action?(i=!i,i?w():(a=[],s=!1),n({isEnabled:i}),!0):"clearHighlights"===t.action?(document.querySelectorAll(".text-highlight").forEach((t=>t.remove())),o.clear(),r.clear(),n({status:"success"}),!0):"whitelistUpdated"===t.action?(w(),n({status:"success"}),!0):void 0)),w(),w()})();
//# sourceMappingURL=content.js.map